<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Testing | MassTransit</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.10d3c714.css" as="style"><link rel="preload" href="/assets/js/app.0285a886.js" as="script"><link rel="preload" href="/assets/js/3.ed085c94.js" as="script"><link rel="preload" href="/assets/js/138.b7495e25.js" as="script"><link rel="prefetch" href="/assets/js/10.4664b18e.js"><link rel="prefetch" href="/assets/js/100.521eb47e.js"><link rel="prefetch" href="/assets/js/101.6dc69973.js"><link rel="prefetch" href="/assets/js/102.6bddc9f5.js"><link rel="prefetch" href="/assets/js/103.221a5e32.js"><link rel="prefetch" href="/assets/js/104.7a9d3561.js"><link rel="prefetch" href="/assets/js/105.992a55d5.js"><link rel="prefetch" href="/assets/js/106.bb89b0bb.js"><link rel="prefetch" href="/assets/js/107.c91fea02.js"><link rel="prefetch" href="/assets/js/108.6224e0f4.js"><link rel="prefetch" href="/assets/js/109.39b59e40.js"><link rel="prefetch" href="/assets/js/11.e65fb4dd.js"><link rel="prefetch" href="/assets/js/110.dae634e5.js"><link rel="prefetch" href="/assets/js/111.4c889386.js"><link rel="prefetch" href="/assets/js/112.e87e3bb4.js"><link rel="prefetch" href="/assets/js/113.c82496c0.js"><link rel="prefetch" href="/assets/js/114.1196b6b6.js"><link rel="prefetch" href="/assets/js/115.f9c3be75.js"><link rel="prefetch" href="/assets/js/116.86a98031.js"><link rel="prefetch" href="/assets/js/117.4e172665.js"><link rel="prefetch" href="/assets/js/118.f955d9b2.js"><link rel="prefetch" href="/assets/js/119.7ba6c616.js"><link rel="prefetch" href="/assets/js/12.a3fdfa3d.js"><link rel="prefetch" href="/assets/js/120.1500a82c.js"><link rel="prefetch" href="/assets/js/121.49da4f03.js"><link rel="prefetch" href="/assets/js/122.1447c040.js"><link rel="prefetch" href="/assets/js/123.3eba400d.js"><link rel="prefetch" href="/assets/js/124.11e37f2a.js"><link rel="prefetch" href="/assets/js/125.c0d86ef4.js"><link rel="prefetch" href="/assets/js/126.92057799.js"><link rel="prefetch" href="/assets/js/127.268c2774.js"><link rel="prefetch" href="/assets/js/128.3e18db43.js"><link rel="prefetch" href="/assets/js/129.5a12693a.js"><link rel="prefetch" href="/assets/js/13.a1e1950a.js"><link rel="prefetch" href="/assets/js/130.16a342ad.js"><link rel="prefetch" href="/assets/js/131.c3635c42.js"><link rel="prefetch" href="/assets/js/132.de6b0df7.js"><link rel="prefetch" href="/assets/js/133.7179d94d.js"><link rel="prefetch" href="/assets/js/134.e15fa251.js"><link rel="prefetch" href="/assets/js/135.8cf6c306.js"><link rel="prefetch" href="/assets/js/136.364d6d81.js"><link rel="prefetch" href="/assets/js/137.38b29357.js"><link rel="prefetch" href="/assets/js/139.ec45975e.js"><link rel="prefetch" href="/assets/js/14.ffd071f1.js"><link rel="prefetch" href="/assets/js/140.e19ba9e8.js"><link rel="prefetch" href="/assets/js/141.bd5bd66c.js"><link rel="prefetch" href="/assets/js/142.cc367b50.js"><link rel="prefetch" href="/assets/js/143.93a7c6d9.js"><link rel="prefetch" href="/assets/js/144.8a4c62e1.js"><link rel="prefetch" href="/assets/js/15.bb6e1b74.js"><link rel="prefetch" href="/assets/js/16.9ffaa291.js"><link rel="prefetch" href="/assets/js/17.232013c5.js"><link rel="prefetch" href="/assets/js/18.ad084001.js"><link rel="prefetch" href="/assets/js/19.3da9ad58.js"><link rel="prefetch" href="/assets/js/20.d1fad9d8.js"><link rel="prefetch" href="/assets/js/21.f87865b3.js"><link rel="prefetch" href="/assets/js/22.af0a9f2e.js"><link rel="prefetch" href="/assets/js/23.e2d8f51a.js"><link rel="prefetch" href="/assets/js/24.e6d92251.js"><link rel="prefetch" href="/assets/js/25.4a62dbc7.js"><link rel="prefetch" href="/assets/js/26.46955a2d.js"><link rel="prefetch" href="/assets/js/27.e5f38990.js"><link rel="prefetch" href="/assets/js/28.f4311d18.js"><link rel="prefetch" href="/assets/js/29.5b5eab97.js"><link rel="prefetch" href="/assets/js/30.2799302d.js"><link rel="prefetch" href="/assets/js/31.ed423d27.js"><link rel="prefetch" href="/assets/js/32.5d6eeef0.js"><link rel="prefetch" href="/assets/js/33.150a8095.js"><link rel="prefetch" href="/assets/js/34.7d42cc21.js"><link rel="prefetch" href="/assets/js/35.063c255c.js"><link rel="prefetch" href="/assets/js/36.15cef90f.js"><link rel="prefetch" href="/assets/js/37.8a6e504b.js"><link rel="prefetch" href="/assets/js/38.bee623db.js"><link rel="prefetch" href="/assets/js/39.c6419725.js"><link rel="prefetch" href="/assets/js/4.7df36a6c.js"><link rel="prefetch" href="/assets/js/40.ce1e8e7b.js"><link rel="prefetch" href="/assets/js/41.343d67f5.js"><link rel="prefetch" href="/assets/js/42.5359f115.js"><link rel="prefetch" href="/assets/js/43.4eab0ad4.js"><link rel="prefetch" href="/assets/js/44.4aaaa1e9.js"><link rel="prefetch" href="/assets/js/45.9f062233.js"><link rel="prefetch" href="/assets/js/46.029a65d8.js"><link rel="prefetch" href="/assets/js/47.5e86e2ab.js"><link rel="prefetch" href="/assets/js/48.a9824b7a.js"><link rel="prefetch" href="/assets/js/49.95f68b0a.js"><link rel="prefetch" href="/assets/js/5.edf7f764.js"><link rel="prefetch" href="/assets/js/50.14766090.js"><link rel="prefetch" href="/assets/js/51.288d4268.js"><link rel="prefetch" href="/assets/js/52.145258d7.js"><link rel="prefetch" href="/assets/js/53.cfedf356.js"><link rel="prefetch" href="/assets/js/54.b219bb82.js"><link rel="prefetch" href="/assets/js/55.0f092b8d.js"><link rel="prefetch" href="/assets/js/56.94b4efb7.js"><link rel="prefetch" href="/assets/js/57.f5b797bf.js"><link rel="prefetch" href="/assets/js/58.f75104cf.js"><link rel="prefetch" href="/assets/js/59.bf8ec211.js"><link rel="prefetch" href="/assets/js/6.8e720dfb.js"><link rel="prefetch" href="/assets/js/60.87367e7f.js"><link rel="prefetch" href="/assets/js/61.b0df016b.js"><link rel="prefetch" href="/assets/js/62.445689cc.js"><link rel="prefetch" href="/assets/js/63.d13ef97e.js"><link rel="prefetch" href="/assets/js/64.75046760.js"><link rel="prefetch" href="/assets/js/65.afd3aea1.js"><link rel="prefetch" href="/assets/js/66.9199174c.js"><link rel="prefetch" href="/assets/js/67.68979a22.js"><link rel="prefetch" href="/assets/js/68.7dc6533f.js"><link rel="prefetch" href="/assets/js/69.05b365c2.js"><link rel="prefetch" href="/assets/js/7.d411127e.js"><link rel="prefetch" href="/assets/js/70.2bea9937.js"><link rel="prefetch" href="/assets/js/71.a0c02df1.js"><link rel="prefetch" href="/assets/js/72.9bcafbd2.js"><link rel="prefetch" href="/assets/js/73.7e27fb04.js"><link rel="prefetch" href="/assets/js/74.2e777193.js"><link rel="prefetch" href="/assets/js/75.01d5b44f.js"><link rel="prefetch" href="/assets/js/76.439d5b29.js"><link rel="prefetch" href="/assets/js/77.2326a3bf.js"><link rel="prefetch" href="/assets/js/78.0490ab0d.js"><link rel="prefetch" href="/assets/js/79.eb31d268.js"><link rel="prefetch" href="/assets/js/8.4cdb2372.js"><link rel="prefetch" href="/assets/js/80.87ffba09.js"><link rel="prefetch" href="/assets/js/81.96fe4f52.js"><link rel="prefetch" href="/assets/js/82.1071de63.js"><link rel="prefetch" href="/assets/js/83.4fcf2a50.js"><link rel="prefetch" href="/assets/js/84.668ce9b6.js"><link rel="prefetch" href="/assets/js/85.0cd583fb.js"><link rel="prefetch" href="/assets/js/86.25f53ebc.js"><link rel="prefetch" href="/assets/js/87.81494f85.js"><link rel="prefetch" href="/assets/js/88.7d618ad5.js"><link rel="prefetch" href="/assets/js/89.ad90e21c.js"><link rel="prefetch" href="/assets/js/9.307c805f.js"><link rel="prefetch" href="/assets/js/90.5761e417.js"><link rel="prefetch" href="/assets/js/91.74a77aa9.js"><link rel="prefetch" href="/assets/js/92.cce73881.js"><link rel="prefetch" href="/assets/js/93.2c2c17c3.js"><link rel="prefetch" href="/assets/js/94.f5c6b161.js"><link rel="prefetch" href="/assets/js/95.6160e31e.js"><link rel="prefetch" href="/assets/js/96.0fa9288b.js"><link rel="prefetch" href="/assets/js/97.50cbe0f3.js"><link rel="prefetch" href="/assets/js/98.9c42acd8.js"><link rel="prefetch" href="/assets/js/99.d7d2a3cd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4ad889dc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.10d3c714.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/live-coding.html" class="sidebar-link">Live Coding</a></li><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" aria-current="page" class="active sidebar-link">Testing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/testing.html#consumer" class="sidebar-link">Consumer</a></li><li class="sidebar-sub-header"><a href="/usage/testing.html#saga" class="sidebar-link">Saga</a></li><li class="sidebar-sub-header"><a href="/usage/testing.html#state-machine-saga" class="sidebar-link">State Machine Saga</a></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="testing"><a href="#testing" class="header-anchor">#</a> Testing</h1> <p>MassTransit is a framework, and follows the Hollywood principle – don't call us, we'll call you. This inversion of control, combined with asynchronous execution, can complicate unit tests. To make it easy, MassTransit includes test harnesses to create unit tests that run entirely in-memory but behave close to an actual message broker. In fact, the included memory-based messaging fabric was inspired by RabbitMQ exchanges and queues.</p> <p>To create a unit test with the in-memory test harness, create and start the harness as shown.</p> <blockquote><p>Uses <a href="https://nuget.org/packages/MassTransit/" target="_blank" rel="noopener noreferrer">MassTransit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,  <a href="https://nuget.org/packages/NUnit/" target="_blank" rel="noopener noreferrer">NUnit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>To create the harness in a unit test, start, and then stop it:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsingInMemoryTestHarness</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Testing</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">NUnit<span class="token punctuation">.</span>Framework</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TestFixture</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Using_the_test_harness</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Test</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_be_easy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> harness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InMemoryTestHarness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>The test harness encapsulates the bus configuration, providing various hooks to customize the bus  and receive endpoint configuration. The in-memory harness is the easiest to use, is lightning fast, and runs entirely in-memory without any external dependencies. Each setup and teardown of the harness provides a completed, end-to-end test environment. Messages sent, published, and consumed go through an entire lifecycle, including serialization, dispatch, deserialization, consumer instantiation, and asynchronous execution.</p> <p>Each supported transport has its own test harness, built from a common base.</p> <h2 id="consumer"><a href="#consumer" class="header-anchor">#</a> Consumer</h2> <p>To test a consumer, use the consumer test harness (available with any transport).</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsingInMemoryTestHarnessConsumer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Testing</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">NUnit<span class="token punctuation">.</span>Framework</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TestFixture</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Submitting_an_order</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Test</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_publish_the_order_submitted_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> harness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InMemoryTestHarness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> consumerHarness <span class="token operator">=</span> harness<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Consumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> harness<span class="token punctuation">.</span>InputQueueSendEndpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
                <span class="token punctuation">{</span>
                    OrderId <span class="token operator">=</span> InVar<span class="token punctuation">.</span>Id 
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// did the endpoint consume the message</span>
                Assert<span class="token punctuation">.</span><span class="token function">That</span><span class="token punctuation">(</span><span class="token keyword">await</span> harness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Any</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// did the actual consumer consume the message</span>
                Assert<span class="token punctuation">.</span><span class="token function">That</span><span class="token punctuation">(</span><span class="token keyword">await</span> consumerHarness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Any</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// the consumer publish the event</span>
                Assert<span class="token punctuation">.</span><span class="token function">That</span><span class="token punctuation">(</span><span class="token keyword">await</span> harness<span class="token punctuation">.</span>Published<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Any</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ensure that no faults were published by the consumer</span>
                Assert<span class="token punctuation">.</span><span class="token function">That</span><span class="token punctuation">(</span><span class="token keyword">await</span> harness<span class="token punctuation">.</span>Published<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Any</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Fault<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Is<span class="token punctuation">.</span>False<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">SubmitOrderConsumer</span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
            <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></div><p>The harness configures the consumer on its receive endpoint. The test sends the <em>SubmitOrder</em> event, and assertions are added using harness's observer collections.</p> <h2 id="saga"><a href="#saga" class="header-anchor">#</a> Saga</h2> <p>A standard class-based saga can be testing using the saga test harness.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_test_the_saga</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> harness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InMemoryTestHarness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> sagaHarness <span class="token operator">=</span> harness<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Saga</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MySaga<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Guid</span> sagaId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InitiatingMessage</span><span class="token punctuation">(</span>sagaId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// did the endpoint consume the message</span>
        Assert<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span>harness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InitiatingMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// did the actual consumer consume the message</span>
        Assert<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span>sagaHarness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InitiatingMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span>saga<span class="token punctuation">.</span>Created<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CorrelationId <span class="token operator">==</span> sagaId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="state-machine-saga"><a href="#state-machine-saga" class="header-anchor">#</a> State Machine Saga</h2> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_test_the_state_machine_saga</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> machine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> harness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InMemoryTestHarness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> sagaHarness <span class="token operator">=</span> harness<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">StateMachineSaga</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyInstance<span class="token punctuation">,</span> MyStateMachine<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>machine<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Guid</span> sagaId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> harness<span class="token punctuation">.</span>Bus<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InitialEvent</span><span class="token punctuation">(</span>sagaId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// did the endpoint consume the message</span>
        Assert<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span>harness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InitialEvent<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// did the actual consumer consume the message</span>
        Assert<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span>sagaHarness<span class="token punctuation">.</span>Consumed<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InitialEvent<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MyInstance</span> instance <span class="token operator">=</span> sagaHarness<span class="token punctuation">.</span>Created<span class="token punctuation">.</span><span class="token function">ContainsInState</span><span class="token punctuation">(</span>sagaId<span class="token punctuation">,</span> machine<span class="token punctuation">,</span> machine<span class="token punctuation">.</span>Active<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">IsNotNull</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">&quot;Saga instance not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> harness<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/testing.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/11/2020, 3:18:17 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usage/containers/structuremap.html" class="prev">
        StructureMap
      </a></span> <span class="next"><a href="/advanced/scheduling/scheduling-api.html">
        Schedule Messages
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0285a886.js" defer></script><script src="/assets/js/3.ed085c94.js" defer></script><script src="/assets/js/138.b7495e25.js" defer></script>
  </body>
</html>
