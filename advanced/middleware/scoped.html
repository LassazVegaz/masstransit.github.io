<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scoped Filters | MassTransit</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.10d3c714.css" as="style"><link rel="preload" href="/assets/js/app.0285a886.js" as="script"><link rel="preload" href="/assets/js/3.ed085c94.js" as="script"><link rel="preload" href="/assets/js/31.ed423d27.js" as="script"><link rel="prefetch" href="/assets/js/10.4664b18e.js"><link rel="prefetch" href="/assets/js/100.521eb47e.js"><link rel="prefetch" href="/assets/js/101.6dc69973.js"><link rel="prefetch" href="/assets/js/102.6bddc9f5.js"><link rel="prefetch" href="/assets/js/103.221a5e32.js"><link rel="prefetch" href="/assets/js/104.7a9d3561.js"><link rel="prefetch" href="/assets/js/105.992a55d5.js"><link rel="prefetch" href="/assets/js/106.bb89b0bb.js"><link rel="prefetch" href="/assets/js/107.c91fea02.js"><link rel="prefetch" href="/assets/js/108.6224e0f4.js"><link rel="prefetch" href="/assets/js/109.39b59e40.js"><link rel="prefetch" href="/assets/js/11.e65fb4dd.js"><link rel="prefetch" href="/assets/js/110.dae634e5.js"><link rel="prefetch" href="/assets/js/111.4c889386.js"><link rel="prefetch" href="/assets/js/112.e87e3bb4.js"><link rel="prefetch" href="/assets/js/113.c82496c0.js"><link rel="prefetch" href="/assets/js/114.1196b6b6.js"><link rel="prefetch" href="/assets/js/115.f9c3be75.js"><link rel="prefetch" href="/assets/js/116.86a98031.js"><link rel="prefetch" href="/assets/js/117.4e172665.js"><link rel="prefetch" href="/assets/js/118.f955d9b2.js"><link rel="prefetch" href="/assets/js/119.7ba6c616.js"><link rel="prefetch" href="/assets/js/12.a3fdfa3d.js"><link rel="prefetch" href="/assets/js/120.1500a82c.js"><link rel="prefetch" href="/assets/js/121.49da4f03.js"><link rel="prefetch" href="/assets/js/122.1447c040.js"><link rel="prefetch" href="/assets/js/123.3eba400d.js"><link rel="prefetch" href="/assets/js/124.11e37f2a.js"><link rel="prefetch" href="/assets/js/125.c0d86ef4.js"><link rel="prefetch" href="/assets/js/126.92057799.js"><link rel="prefetch" href="/assets/js/127.268c2774.js"><link rel="prefetch" href="/assets/js/128.3e18db43.js"><link rel="prefetch" href="/assets/js/129.5a12693a.js"><link rel="prefetch" href="/assets/js/13.a1e1950a.js"><link rel="prefetch" href="/assets/js/130.16a342ad.js"><link rel="prefetch" href="/assets/js/131.c3635c42.js"><link rel="prefetch" href="/assets/js/132.de6b0df7.js"><link rel="prefetch" href="/assets/js/133.7179d94d.js"><link rel="prefetch" href="/assets/js/134.e15fa251.js"><link rel="prefetch" href="/assets/js/135.8cf6c306.js"><link rel="prefetch" href="/assets/js/136.364d6d81.js"><link rel="prefetch" href="/assets/js/137.38b29357.js"><link rel="prefetch" href="/assets/js/138.b7495e25.js"><link rel="prefetch" href="/assets/js/139.ec45975e.js"><link rel="prefetch" href="/assets/js/14.ffd071f1.js"><link rel="prefetch" href="/assets/js/140.e19ba9e8.js"><link rel="prefetch" href="/assets/js/141.bd5bd66c.js"><link rel="prefetch" href="/assets/js/142.cc367b50.js"><link rel="prefetch" href="/assets/js/143.93a7c6d9.js"><link rel="prefetch" href="/assets/js/144.8a4c62e1.js"><link rel="prefetch" href="/assets/js/15.bb6e1b74.js"><link rel="prefetch" href="/assets/js/16.9ffaa291.js"><link rel="prefetch" href="/assets/js/17.232013c5.js"><link rel="prefetch" href="/assets/js/18.ad084001.js"><link rel="prefetch" href="/assets/js/19.3da9ad58.js"><link rel="prefetch" href="/assets/js/20.d1fad9d8.js"><link rel="prefetch" href="/assets/js/21.f87865b3.js"><link rel="prefetch" href="/assets/js/22.af0a9f2e.js"><link rel="prefetch" href="/assets/js/23.e2d8f51a.js"><link rel="prefetch" href="/assets/js/24.e6d92251.js"><link rel="prefetch" href="/assets/js/25.4a62dbc7.js"><link rel="prefetch" href="/assets/js/26.46955a2d.js"><link rel="prefetch" href="/assets/js/27.e5f38990.js"><link rel="prefetch" href="/assets/js/28.f4311d18.js"><link rel="prefetch" href="/assets/js/29.5b5eab97.js"><link rel="prefetch" href="/assets/js/30.2799302d.js"><link rel="prefetch" href="/assets/js/32.5d6eeef0.js"><link rel="prefetch" href="/assets/js/33.150a8095.js"><link rel="prefetch" href="/assets/js/34.7d42cc21.js"><link rel="prefetch" href="/assets/js/35.063c255c.js"><link rel="prefetch" href="/assets/js/36.15cef90f.js"><link rel="prefetch" href="/assets/js/37.8a6e504b.js"><link rel="prefetch" href="/assets/js/38.bee623db.js"><link rel="prefetch" href="/assets/js/39.c6419725.js"><link rel="prefetch" href="/assets/js/4.7df36a6c.js"><link rel="prefetch" href="/assets/js/40.ce1e8e7b.js"><link rel="prefetch" href="/assets/js/41.343d67f5.js"><link rel="prefetch" href="/assets/js/42.5359f115.js"><link rel="prefetch" href="/assets/js/43.4eab0ad4.js"><link rel="prefetch" href="/assets/js/44.4aaaa1e9.js"><link rel="prefetch" href="/assets/js/45.9f062233.js"><link rel="prefetch" href="/assets/js/46.029a65d8.js"><link rel="prefetch" href="/assets/js/47.5e86e2ab.js"><link rel="prefetch" href="/assets/js/48.a9824b7a.js"><link rel="prefetch" href="/assets/js/49.95f68b0a.js"><link rel="prefetch" href="/assets/js/5.edf7f764.js"><link rel="prefetch" href="/assets/js/50.14766090.js"><link rel="prefetch" href="/assets/js/51.288d4268.js"><link rel="prefetch" href="/assets/js/52.145258d7.js"><link rel="prefetch" href="/assets/js/53.cfedf356.js"><link rel="prefetch" href="/assets/js/54.b219bb82.js"><link rel="prefetch" href="/assets/js/55.0f092b8d.js"><link rel="prefetch" href="/assets/js/56.94b4efb7.js"><link rel="prefetch" href="/assets/js/57.f5b797bf.js"><link rel="prefetch" href="/assets/js/58.f75104cf.js"><link rel="prefetch" href="/assets/js/59.bf8ec211.js"><link rel="prefetch" href="/assets/js/6.8e720dfb.js"><link rel="prefetch" href="/assets/js/60.87367e7f.js"><link rel="prefetch" href="/assets/js/61.b0df016b.js"><link rel="prefetch" href="/assets/js/62.445689cc.js"><link rel="prefetch" href="/assets/js/63.d13ef97e.js"><link rel="prefetch" href="/assets/js/64.75046760.js"><link rel="prefetch" href="/assets/js/65.afd3aea1.js"><link rel="prefetch" href="/assets/js/66.9199174c.js"><link rel="prefetch" href="/assets/js/67.68979a22.js"><link rel="prefetch" href="/assets/js/68.7dc6533f.js"><link rel="prefetch" href="/assets/js/69.05b365c2.js"><link rel="prefetch" href="/assets/js/7.d411127e.js"><link rel="prefetch" href="/assets/js/70.2bea9937.js"><link rel="prefetch" href="/assets/js/71.a0c02df1.js"><link rel="prefetch" href="/assets/js/72.9bcafbd2.js"><link rel="prefetch" href="/assets/js/73.7e27fb04.js"><link rel="prefetch" href="/assets/js/74.2e777193.js"><link rel="prefetch" href="/assets/js/75.01d5b44f.js"><link rel="prefetch" href="/assets/js/76.439d5b29.js"><link rel="prefetch" href="/assets/js/77.2326a3bf.js"><link rel="prefetch" href="/assets/js/78.0490ab0d.js"><link rel="prefetch" href="/assets/js/79.eb31d268.js"><link rel="prefetch" href="/assets/js/8.4cdb2372.js"><link rel="prefetch" href="/assets/js/80.87ffba09.js"><link rel="prefetch" href="/assets/js/81.96fe4f52.js"><link rel="prefetch" href="/assets/js/82.1071de63.js"><link rel="prefetch" href="/assets/js/83.4fcf2a50.js"><link rel="prefetch" href="/assets/js/84.668ce9b6.js"><link rel="prefetch" href="/assets/js/85.0cd583fb.js"><link rel="prefetch" href="/assets/js/86.25f53ebc.js"><link rel="prefetch" href="/assets/js/87.81494f85.js"><link rel="prefetch" href="/assets/js/88.7d618ad5.js"><link rel="prefetch" href="/assets/js/89.ad90e21c.js"><link rel="prefetch" href="/assets/js/9.307c805f.js"><link rel="prefetch" href="/assets/js/90.5761e417.js"><link rel="prefetch" href="/assets/js/91.74a77aa9.js"><link rel="prefetch" href="/assets/js/92.cce73881.js"><link rel="prefetch" href="/assets/js/93.2c2c17c3.js"><link rel="prefetch" href="/assets/js/94.f5c6b161.js"><link rel="prefetch" href="/assets/js/95.6160e31e.js"><link rel="prefetch" href="/assets/js/96.0fa9288b.js"><link rel="prefetch" href="/assets/js/97.50cbe0f3.js"><link rel="prefetch" href="/assets/js/98.9c42acd8.js"><link rel="prefetch" href="/assets/js/99.d7d2a3cd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4ad889dc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.10d3c714.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/live-coding.html" class="sidebar-link">Live Coding</a></li><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Advanced</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/scheduling/" class="sidebar-heading clickable"><span>Scheduling</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/courier/" class="sidebar-heading clickable"><span>Courier</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/middleware/" class="sidebar-heading clickable router-link-active open"><span>Middleware</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/middleware/receive.html" class="sidebar-link">Receive Pipeline</a></li><li><a href="/advanced/middleware/killswitch.html" class="sidebar-link">Kill Switch</a></li><li><a href="/advanced/middleware/circuit-breaker.html" class="sidebar-link">Circuit Breaker</a></li><li><a href="/advanced/middleware/rate-limiter.html" class="sidebar-link">Rate Limiter</a></li><li><a href="/advanced/middleware/transactions.html" class="sidebar-link">Transaction</a></li><li><a href="/advanced/middleware/custom.html" class="sidebar-link">Custom</a></li><li><a href="/advanced/middleware/scoped.html" aria-current="page" class="active sidebar-link">Scoped Filters</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/conductor/" class="sidebar-heading clickable"><span>Conductor</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/message-data.html" class="sidebar-link">Message Data</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>Monitoring</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/advanced/connect-endpoint.html" class="sidebar-link">Connect Endpoint</a></li><li><a href="/advanced/observers.html" class="sidebar-link">Observers</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/topology/" class="sidebar-heading clickable"><span>Topology</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/signalr/" class="sidebar-heading clickable"><span>SignalR</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/advanced/audit.html" class="sidebar-link">Message Audit</a></li><li><a href="/advanced/batching.html" class="sidebar-link">Batching</a></li><li><a href="/advanced/job-consumers.html" class="sidebar-link">Job Consumers</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="scoped-filters"><a href="#scoped-filters" class="header-anchor">#</a> Scoped Filters</h1> <p>Most of the built-in filters are created and added to the pipeline during configuration. This approach is typically sufficient, however, there are scenarios where the filter needs access to other components at runtime.</p> <p>Using a scoped filter, combined with a supported dependency injection container (either MSDI or Autofac), allows a new filter instance to be resolved from the container for each message. If a current scope is not available, a new scope will be created using the root container.</p> <h3 id="filter-classes"><a href="#filter-classes" class="header-anchor">#</a> Filter Classes</h3> <p>Scoped filters must be generic classes with a single generic argument for the message type. For example, a scoped consume filter would be defined as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TFilter<span class="token punctuation">&lt;</span>TMessage<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&lt;</span>TMessage<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
</code></pre></div><h3 id="supported-filter-contexts"><a href="#supported-filter-contexts" class="header-anchor">#</a> Supported Filter Contexts</h3> <p>Scope filters are added using one of the following methods, which are specific to the filter context type.</p> <table><thead><tr><th>Type</th> <th>Usage</th></tr></thead> <tbody><tr><td><code>ConsumeContext&lt;T&gt;</code></td> <td><code>UseConsumeFilter(typeof(TFilter&lt;&gt;), context)</code></td></tr> <tr><td><code>SendContext&lt;T&gt;</code></td> <td><code>UseSendFilter(typeof(TFilter&lt;&gt;), context)</code></td></tr> <tr><td><code>PublishContext&lt;T&gt;</code></td> <td><code>UsePublishFilter(typeof(TFilter&lt;&gt;), context)</code></td></tr> <tr><td><code>ExecuteContext&lt;TArguments&gt;</code></td> <td><code>UseExecuteActivityFilter(typeof(TFilter&lt;&gt;), context)</code></td></tr> <tr><td><code>CompensateContext&lt;TLog&gt;</code></td> <td><code>UseCompensateActivityFilter(typeof(TFilter&lt;&gt;), context)</code></td></tr></tbody></table> <p>More information could be found inside <a href="/advanced/middleware/" class="router-link-active">middleware</a> section</p> <h3 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h3> <p>To create a <code>ConsumeContext&lt;T&gt;</code> filter and add it to the receive endpoint:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumeFilter<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MyConsumeFilter</span><span class="token punctuation">(</span><span class="token class-name">IMyDependency</span> dependency<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      	<span class="token comment">//other configuration</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMyDependency<span class="token punctuation">,</span> MyDependency<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//register dependency</span>

        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyConsumeFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//generic filter</span>

                    e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To create a <code>SendContext&lt;T&gt;</code> filter and add it to the send pipeline:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySendFilter<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MySendFilter</span><span class="token punctuation">(</span><span class="token class-name">IMyDependency</span> dependency<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//other configuration</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMyDependency<span class="token punctuation">,</span> MyDependency<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//register dependency</span>
          
        services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
              cfg<span class="token punctuation">.</span><span class="token function">UseSendFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MySendFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//generic filter</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="combining-consume-and-send-publish-filters"><a href="#combining-consume-and-send-publish-filters" class="header-anchor">#</a> Combining Consume And Send/Publish Filters</h3> <p>A common use case with scoped filters is transferring data between the consumer. This data may be extracted from headers, or could include context or authorization information that needs to be passed from a consumed message context to sent or published messages. In these situations, there <em>may</em> be some special requirements to ensure everything works as expected.</p> <p>The following example has both consume and send filters, and utilize a shared dependency to communicate data to outbound messages.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumeFilter<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MyConsumeFilter</span><span class="token punctuation">(</span><span class="token class-name">MyDependency</span> dependency<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySendFilter<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MySendFilter</span><span class="token punctuation">(</span><span class="token class-name">MyDependency</span> dependency<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDependency</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SomeValue <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDependency<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token function">UseSendFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MySendFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyConsumeFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>When using the InMemoryOutbox with scoped publish or send filters, <code>UseMessageScope</code> (for MSDI) or <code>UseMessageLifetimeScope</code> (for Autofac) must be configured <em>before</em> the InMemoryOutbox. If <code>UseMessageRetry</code> is used, it must come <em>before</em> either <code>UseMessageScope</code> or <code>UseMessageLifetimeScope</code>.</p></div> <p>Because the InMemoryOutbox delays publishing and sending messages until after the consumer or saga completes, the created container scope will have been disposed. The <code>UseMessageScope</code> or <code>UseMessageLifetimeScope</code> filters create the scope before the InMemoryOutbox, which is then used by the consumer or saga and any scoped filters (consume, publish, or send).</p> <p>The updated receive endpoint configuration using the InMemoryOutbox is shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Intervals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">UseMessageScope</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">UseInMemoryOutbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    e<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyConsumeFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/advanced/middleware/scoped.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/4/2020, 2:01:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/middleware/custom.html" class="prev">
        Custom
      </a></span> <span class="next"><a href="/advanced/conductor/configuration.html">
        Configuration
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0285a886.js" defer></script><script src="/assets/js/3.ed085c94.js" defer></script><script src="/assets/js/31.ed423d27.js" defer></script>
  </body>
</html>
