<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Transactional Outbox | MassTransit</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.b0a18694.css" as="style"><link rel="preload" href="/assets/js/app.f6b98727.js" as="script"><link rel="preload" href="/assets/js/3.5d941158.js" as="script"><link rel="preload" href="/assets/js/61.fdf4d890.js" as="script"><link rel="prefetch" href="/assets/js/10.49f30773.js"><link rel="prefetch" href="/assets/js/100.243463e8.js"><link rel="prefetch" href="/assets/js/101.6c574e04.js"><link rel="prefetch" href="/assets/js/102.3f8ecb5a.js"><link rel="prefetch" href="/assets/js/103.102e0b62.js"><link rel="prefetch" href="/assets/js/104.6415c50e.js"><link rel="prefetch" href="/assets/js/105.d79d3e11.js"><link rel="prefetch" href="/assets/js/106.e54af3e0.js"><link rel="prefetch" href="/assets/js/107.81005321.js"><link rel="prefetch" href="/assets/js/108.f5a33270.js"><link rel="prefetch" href="/assets/js/109.ae5298f8.js"><link rel="prefetch" href="/assets/js/11.3829db40.js"><link rel="prefetch" href="/assets/js/110.194ac2eb.js"><link rel="prefetch" href="/assets/js/111.6e7fe707.js"><link rel="prefetch" href="/assets/js/112.61cc9d22.js"><link rel="prefetch" href="/assets/js/113.d3f0314f.js"><link rel="prefetch" href="/assets/js/114.c7cb5e12.js"><link rel="prefetch" href="/assets/js/115.b6551b88.js"><link rel="prefetch" href="/assets/js/116.1496da4c.js"><link rel="prefetch" href="/assets/js/117.e885181b.js"><link rel="prefetch" href="/assets/js/118.3bbcc28f.js"><link rel="prefetch" href="/assets/js/119.e0e97b90.js"><link rel="prefetch" href="/assets/js/12.3734f329.js"><link rel="prefetch" href="/assets/js/120.444e5052.js"><link rel="prefetch" href="/assets/js/121.362cfe2e.js"><link rel="prefetch" href="/assets/js/122.eaadaf77.js"><link rel="prefetch" href="/assets/js/123.b6b5c5fd.js"><link rel="prefetch" href="/assets/js/124.9874f788.js"><link rel="prefetch" href="/assets/js/125.9193edd8.js"><link rel="prefetch" href="/assets/js/126.ddc4474b.js"><link rel="prefetch" href="/assets/js/127.77536101.js"><link rel="prefetch" href="/assets/js/128.5dd52fc7.js"><link rel="prefetch" href="/assets/js/129.6c99a810.js"><link rel="prefetch" href="/assets/js/13.8bf0f23e.js"><link rel="prefetch" href="/assets/js/130.faa12e2e.js"><link rel="prefetch" href="/assets/js/131.ff600709.js"><link rel="prefetch" href="/assets/js/132.8d824641.js"><link rel="prefetch" href="/assets/js/133.c26af601.js"><link rel="prefetch" href="/assets/js/134.c932e5ca.js"><link rel="prefetch" href="/assets/js/135.1a11d73e.js"><link rel="prefetch" href="/assets/js/136.39cbc21a.js"><link rel="prefetch" href="/assets/js/137.21b966f9.js"><link rel="prefetch" href="/assets/js/138.9248d545.js"><link rel="prefetch" href="/assets/js/139.a304bb6f.js"><link rel="prefetch" href="/assets/js/14.b897aaa9.js"><link rel="prefetch" href="/assets/js/140.4f8b455e.js"><link rel="prefetch" href="/assets/js/141.d6ddbdd1.js"><link rel="prefetch" href="/assets/js/142.9d701fd3.js"><link rel="prefetch" href="/assets/js/143.4fedc479.js"><link rel="prefetch" href="/assets/js/144.0d30d704.js"><link rel="prefetch" href="/assets/js/145.47c48ec2.js"><link rel="prefetch" href="/assets/js/146.da2c710e.js"><link rel="prefetch" href="/assets/js/147.b69eceaa.js"><link rel="prefetch" href="/assets/js/148.6dce1a86.js"><link rel="prefetch" href="/assets/js/149.905b3fea.js"><link rel="prefetch" href="/assets/js/15.296f2506.js"><link rel="prefetch" href="/assets/js/150.609e2610.js"><link rel="prefetch" href="/assets/js/151.e4daa07f.js"><link rel="prefetch" href="/assets/js/152.96960b84.js"><link rel="prefetch" href="/assets/js/153.8b026a84.js"><link rel="prefetch" href="/assets/js/154.535d9002.js"><link rel="prefetch" href="/assets/js/155.d131882f.js"><link rel="prefetch" href="/assets/js/156.92594355.js"><link rel="prefetch" href="/assets/js/157.177b171c.js"><link rel="prefetch" href="/assets/js/158.ab8e722b.js"><link rel="prefetch" href="/assets/js/159.0b52ad96.js"><link rel="prefetch" href="/assets/js/16.adccd4e8.js"><link rel="prefetch" href="/assets/js/160.b3a57bd7.js"><link rel="prefetch" href="/assets/js/161.19741734.js"><link rel="prefetch" href="/assets/js/162.bf246d2a.js"><link rel="prefetch" href="/assets/js/163.17cf9d0d.js"><link rel="prefetch" href="/assets/js/164.e9a5db3b.js"><link rel="prefetch" href="/assets/js/165.7a695acf.js"><link rel="prefetch" href="/assets/js/166.e567e23a.js"><link rel="prefetch" href="/assets/js/167.49861f38.js"><link rel="prefetch" href="/assets/js/168.6f8b5b89.js"><link rel="prefetch" href="/assets/js/17.85c3c1f1.js"><link rel="prefetch" href="/assets/js/18.53360c2c.js"><link rel="prefetch" href="/assets/js/19.03f35ec0.js"><link rel="prefetch" href="/assets/js/20.f729ad0e.js"><link rel="prefetch" href="/assets/js/21.04d5ff0d.js"><link rel="prefetch" href="/assets/js/22.be6c32fa.js"><link rel="prefetch" href="/assets/js/23.efc1c82b.js"><link rel="prefetch" href="/assets/js/24.12a32996.js"><link rel="prefetch" href="/assets/js/25.bddeb4c3.js"><link rel="prefetch" href="/assets/js/26.85161e49.js"><link rel="prefetch" href="/assets/js/27.95bc6c7b.js"><link rel="prefetch" href="/assets/js/28.4ed8117b.js"><link rel="prefetch" href="/assets/js/29.e1c9da66.js"><link rel="prefetch" href="/assets/js/30.488c2a55.js"><link rel="prefetch" href="/assets/js/31.22627d31.js"><link rel="prefetch" href="/assets/js/32.0a1c75b8.js"><link rel="prefetch" href="/assets/js/33.2b56409c.js"><link rel="prefetch" href="/assets/js/34.949f2f08.js"><link rel="prefetch" href="/assets/js/35.30b31a5f.js"><link rel="prefetch" href="/assets/js/36.725999db.js"><link rel="prefetch" href="/assets/js/37.f96e32d8.js"><link rel="prefetch" href="/assets/js/38.a9bc1b6b.js"><link rel="prefetch" href="/assets/js/39.d83c0fdc.js"><link rel="prefetch" href="/assets/js/4.8191bfff.js"><link rel="prefetch" href="/assets/js/40.67b3ecf0.js"><link rel="prefetch" href="/assets/js/41.ca6c692b.js"><link rel="prefetch" href="/assets/js/42.8104214f.js"><link rel="prefetch" href="/assets/js/43.de53e242.js"><link rel="prefetch" href="/assets/js/44.ba235ee4.js"><link rel="prefetch" href="/assets/js/45.3114f8ea.js"><link rel="prefetch" href="/assets/js/46.be28e80a.js"><link rel="prefetch" href="/assets/js/47.540c8a33.js"><link rel="prefetch" href="/assets/js/48.16f0bcb2.js"><link rel="prefetch" href="/assets/js/49.62e71c16.js"><link rel="prefetch" href="/assets/js/5.599e6a7c.js"><link rel="prefetch" href="/assets/js/50.d7b6a73f.js"><link rel="prefetch" href="/assets/js/51.cd1681d8.js"><link rel="prefetch" href="/assets/js/52.912b7eb4.js"><link rel="prefetch" href="/assets/js/53.f63cbbaa.js"><link rel="prefetch" href="/assets/js/54.a0272657.js"><link rel="prefetch" href="/assets/js/55.304f3a6c.js"><link rel="prefetch" href="/assets/js/56.87f1f07e.js"><link rel="prefetch" href="/assets/js/57.bd29545b.js"><link rel="prefetch" href="/assets/js/58.71aa225e.js"><link rel="prefetch" href="/assets/js/59.de4b1bce.js"><link rel="prefetch" href="/assets/js/6.86af36b9.js"><link rel="prefetch" href="/assets/js/60.a96f7f49.js"><link rel="prefetch" href="/assets/js/62.a46c4e4e.js"><link rel="prefetch" href="/assets/js/63.8b996549.js"><link rel="prefetch" href="/assets/js/64.7dbbcad1.js"><link rel="prefetch" href="/assets/js/65.fd2081e5.js"><link rel="prefetch" href="/assets/js/66.98915198.js"><link rel="prefetch" href="/assets/js/67.702c35c3.js"><link rel="prefetch" href="/assets/js/68.dc4a8d40.js"><link rel="prefetch" href="/assets/js/69.71fdb01b.js"><link rel="prefetch" href="/assets/js/7.096060b8.js"><link rel="prefetch" href="/assets/js/70.0d08616b.js"><link rel="prefetch" href="/assets/js/71.63f0a6b5.js"><link rel="prefetch" href="/assets/js/72.bbd78022.js"><link rel="prefetch" href="/assets/js/73.51adbfa1.js"><link rel="prefetch" href="/assets/js/74.98e47b95.js"><link rel="prefetch" href="/assets/js/75.5b3939ab.js"><link rel="prefetch" href="/assets/js/76.2e50b5f0.js"><link rel="prefetch" href="/assets/js/77.ccfd5f23.js"><link rel="prefetch" href="/assets/js/78.8abc56aa.js"><link rel="prefetch" href="/assets/js/79.c299f8de.js"><link rel="prefetch" href="/assets/js/8.b737c7b7.js"><link rel="prefetch" href="/assets/js/80.ccaa0b39.js"><link rel="prefetch" href="/assets/js/81.a7229866.js"><link rel="prefetch" href="/assets/js/82.487e273f.js"><link rel="prefetch" href="/assets/js/83.e4cbe993.js"><link rel="prefetch" href="/assets/js/84.f2ca382d.js"><link rel="prefetch" href="/assets/js/85.7012d877.js"><link rel="prefetch" href="/assets/js/86.5f31ac47.js"><link rel="prefetch" href="/assets/js/87.7387ff31.js"><link rel="prefetch" href="/assets/js/88.d992463d.js"><link rel="prefetch" href="/assets/js/89.014bfaf2.js"><link rel="prefetch" href="/assets/js/9.e7dfcdd2.js"><link rel="prefetch" href="/assets/js/90.496afa55.js"><link rel="prefetch" href="/assets/js/91.71f14531.js"><link rel="prefetch" href="/assets/js/92.7761c13e.js"><link rel="prefetch" href="/assets/js/93.60a806d9.js"><link rel="prefetch" href="/assets/js/94.d22093c0.js"><link rel="prefetch" href="/assets/js/95.a1d7fcb2.js"><link rel="prefetch" href="/assets/js/96.af12f65e.js"><link rel="prefetch" href="/assets/js/97.1f5d834b.js"><link rel="prefetch" href="/assets/js/98.e57ea119.js"><link rel="prefetch" href="/assets/js/99.c11b5ac6.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4b97fc91.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0a18694.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/quick-starts/" class="sidebar-heading clickable open"><span>Quick Starts</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/quick-starts/in-memory.html" class="sidebar-link">In Memory</a></li><li><a href="/quick-starts/rabbitmq.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/quick-starts/azure-service-bus.html" class="sidebar-link">Azure Service Bus</a></li><li><a href="/quick-starts/sqs.html" class="sidebar-link">SQS</a></li></ul></section></li><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/templates.html" class="sidebar-link">Templates</a></li><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/faas/" class="sidebar-heading clickable"><span>FaaS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/guidance.html" class="sidebar-link">Guidance</a></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Advanced</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/scheduling/" class="sidebar-heading clickable open"><span>Scheduling</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/scheduling/scheduling-api.html" class="sidebar-link">Schedule Messages</a></li><li><a href="/advanced/scheduling/activemq-delayed.html" class="sidebar-link">ActiveMQ</a></li><li><a href="/advanced/scheduling/amazonsqs-scheduler.html" class="sidebar-link">Amazon SQS</a></li><li><a href="/advanced/scheduling/azure-sb-scheduler.html" class="sidebar-link">Azure Service Bus</a></li><li><a href="/advanced/scheduling/rabbitmq-delayed.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/advanced/scheduling/hangfire.html" class="sidebar-link">Hangfire Scheduler</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/courier/" class="sidebar-heading clickable"><span>Courier</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/middleware/" class="sidebar-heading clickable"><span>Middleware</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/advanced/transactional-outbox.html" aria-current="page" class="active sidebar-link">Transactional Outbox</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/usage/message-data.html" class="sidebar-link">Message Data</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>Monitoring</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/advanced/connect-endpoint.html" class="sidebar-link">Connect Endpoint</a></li><li><a href="/advanced/observers.html" class="sidebar-link">Observers</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/topology/" class="sidebar-heading clickable"><span>Topology</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/advanced/signalr/" class="sidebar-heading clickable"><span>SignalR</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/advanced/audit.html" class="sidebar-link">Message Audit</a></li><li><a href="/advanced/batching.html" class="sidebar-link">Batching</a></li><li><a href="/advanced/job-consumers.html" class="sidebar-link">Job Consumers</a></li></ul></section></li></ul></section></li><li><a href="/support.html" class="sidebar-link">Support</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="transactional-outbox"><a href="#transactional-outbox" class="header-anchor">#</a> Transactional Outbox</h1> <p>It is common that a service may need to combine database writes with publishing events and/or sending commands. And in this scenario, it is usually desirable to do this atomically in a transaction. However, message brokers typically do not participate in transactions. Even if a message broker did support transactions, it would require two-phase commit (2PC) which should be avoided whenever possible.</p> <blockquote><p>While MassTransit has long provided an <a href="/articles/outbox">in-memory outbox</a>, there has often been criticism that it isn't a <em>real</em> outbox. And while I have proven that it works, is reliable, and is extremely fast (broker message delivery speed), it does require care to ensure operations are idempotent and when an idempotent operation is detected events are republished. The in-memory outbox also does not function as an <em>inbox</em>, so exactly-once message delivery is not supported.</p></blockquote> <p>The Transactional Outbox has two main components:</p> <ul><li><p>The <strong>Bus Outbox</strong> works within a container scope (such as the scope created for an ASP.NET Controller) and adds published and sent messages to the specified <code>DbContext</code>. Once the changes are saved, the messages are available to the delivery service which delivers them to the broker.</p></li> <li><p>The <strong>Consumer Outbox</strong> is a combination of an <em>inbox</em> and an <em>outbox</em>. The <em>inbox</em> is used to keep track of received messages to guarantee  exactly-once consumer behavior. The <em>outbox</em> is used to store published and sent messages until the consumer completes successfully. Once completed, the stored messages are delivered to the broker after which the received message is acknowledged. The Consumer Outbox works with all consumer types, including Consumers, Sagas, and Courier Actvities.</p></li></ul> <p>Either of these components can be used independently or both at the same time.</p> <h3 id="bus-outbox-behavior"><a href="#bus-outbox-behavior" class="header-anchor">#</a> Bus Outbox Behavior</h3> <p>Normally when messages are published or sent they are delivered directly to the message broker:</p> <p><img src="/write-to-broker.png" alt="Delivery to Broker" title="Delivery to Broker"></p> <p>When the bus outbox is configured, the scoped interfaces are replaced with versions that write to the outbox. Since <code>ISendEndpointProvider</code> and <code>IPublishEndpoint</code> are registered as scoped in the container, they are able to share the same scope as the <code>DbContext</code> used by the application.</p> <p><img src="/write-to-outbox.png" alt="Delivery to Outbox" title="Delivery to Outbox"></p> <p>Once the changes are saved in the <code>DbContext</code> (typically by the application calling <code>SaveChangesAsync</code>), the messages will be written to the database as part of the transaction and will be available to the delivery service.</p> <p>The delivery service queries the <code>OutboxMessage</code> table for messages published or sent via the Bus Outbox, and attempts to deliver any messages found to the message broker.</p> <p><img src="/outbox-to-broker.png" alt="Delivery to Broker" title="Delivery to Broker"></p> <p>The delivery service uses the <em>OutboxState</em> table to ensure that messages are delivered to the broker in the order they were published/sent. The <em>OutboxState</em> table is also used to lock messages so that multiple instances of the delivery service can coexist without conflict.</p> <h3 id="consumer-outbox-behavior"><a href="#consumer-outbox-behavior" class="header-anchor">#</a> Consumer Outbox Behavior</h3> <p>Normally, when messages are published or sent by a consumer or one of its dependencies they are delivered directly to the message broker:</p> <p><img src="/consumer-regular.png" alt="Regular Consumer Behavior" title="Regular Consumer Behavior"></p> <p>When the outbox is configured, the behavior changes. As a message is received, the <em>inbox</em> is used to lock the message by <code>MessageId</code>.</p> <p><img src="/consumer-inbox.png" alt="Consumer Inbox" title="Consumer Inbox"></p> <p>When the consumer publishes or sends a message, instead of being delivered to the broker it is stored in the <em>OutboxMessage</em> table.</p> <p><img src="/inbox-outbox.png" alt="Inbox to Outbox" title="Inbox to Outbox"></p> <p>Once the consumer completes and the messages are saved to the outbox, those messages are delivered to the message broker in the order they were produced.</p> <p><img src="/inbox-outbox-broker.png" alt="Deliver Outbox to Broker" title="Deliver Outbox to Broker"></p> <p>If there are issues delivering the messages to the broker, message retry will continue to attempt message delivery.</p> <h3 id="entity-framework-outbox"><a href="#entity-framework-outbox" class="header-anchor">#</a> Entity Framework Outbox</h3> <p>The Transactional Outbox for Entity Framework Core uses three tables in the <code>DbContext</code> to store messages that are subsequently delivered to the message broker.</p> <table><thead><tr><th>Table</th> <th>Description</th></tr></thead> <tbody><tr><td>InboxState</td> <td>Tracks received messages by <code>MessageId</code> for each endpoint</td></tr> <tr><td>OutboxMessage</td> <td>Stores messages published or sent using <code>ConsumeContext</code>, <code>IPublishEndpoint</code>, and <code>ISendEndpointProvider</code></td></tr> <tr><td>OutboxState</td> <td>Tracks delivery of outbox messages by the delivery service (similar to <em>InboxState</em> but for message sent outside of a consumer via the bus outbox)</td></tr></tbody></table> <h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <blockquote><p>The code below is based upon the <a href="https://github.com/MassTransit/Sample-Outbox" target="_blank" rel="noopener noreferrer">sample application<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>The outbox components are included in the <code>MassTransit.EntityFrameworkCore</code> NuGet packages. The code below configures both the bus outbox and the consumer outbox using the default settings. In this case, PostgreSQL is the database engine.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddEntityFrameworkOutbox</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RegistrationDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	<span class="token comment">// configure which database lock provider to use (Postgres, SqlServer, or MySql)</span>
	o<span class="token punctuation">.</span><span class="token function">UsePostgres</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// enable the bus outbox</span>
    o<span class="token punctuation">.</span><span class="token function">UseBusOutbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>To configure the <em>DbContext</em> with the appropriate tables, use the extension methods shown below:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegistrationDbContext</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">RegistrationDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>RegistrationDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnModelCreating</span><span class="token punctuation">(</span>modelBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        modelBuilder<span class="token punctuation">.</span><span class="token function">AddInboxStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelBuilder<span class="token punctuation">.</span><span class="token function">AddOutboxMessageEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelBuilder<span class="token punctuation">.</span><span class="token function">AddOutboxStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To configure the outbox on a receive endpoint, configure the receive endpoint as shown below. The configuration below uses a <code>SagaDefinition</code> to configure the receive endpoint, which is added to MassTransit along with the saga state machine.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegistrationStateDefinition</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaDefinition<span class="token punctuation">&lt;</span>RegistrationState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _provider<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">RegistrationStateDefinition</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> provider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _provider <span class="token operator">=</span> provider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureSaga</span><span class="token punctuation">(</span><span class="token class-name">IReceiveEndpointConfigurator</span> endpointConfigurator<span class="token punctuation">,</span>
        <span class="token class-name">ISagaConfigurator<span class="token punctuation">&lt;</span>RegistrationState<span class="token punctuation">&gt;</span></span> consumerConfigurator<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        endpointConfigurator<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Intervals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        endpointConfigurator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseEntityFrameworkOutbox</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RegistrationDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>_provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The definition is added with the saga state machine:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSagaStateMachine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RegistrationStateMachine<span class="token punctuation">,</span> RegistrationState<span class="token punctuation">,</span> RegistrationStateDefinition<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">EntityFrameworkRepository</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ExistingDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RegistrationDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">UsePostgres</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The Entity Framework outbox adds a hosted service which removes delivered <em>InboxState</em> entries after the <em>DuplicateDetectionWindow</em> has elapsed. The Bus Outbox includes an additional hosted service that delivers the outbox messages to the broker.</p> <h3 id="configuration-options"><a href="#configuration-options" class="header-anchor">#</a> Configuration Options</h3> <p>The available outbox settings are listed below.</p> <table><thead><tr><th>Setting</th> <th>Description</th></tr></thead> <tbody><tr><td>DuplicateDetectionWindow</td> <td>The amount of time a message remains in the inbox for duplicate detection (based on MessageId)</td></tr> <tr><td>IsolationLevel</td> <td>The transaction isolation level to use (Serializable by default)</td></tr> <tr><td>LockStatementProvider</td> <td>The lock statement provider, needed to execute pessimistic locks. Is set via <code>UsePostgres</code>, <code>UseSqlServer</code> (the default), or <code>UseMySql</code></td></tr> <tr><td>QueryDelay</td> <td>The delay between queries once messages are no longer available. When a query returns messages, subsequent queries are performed until no messages are returned after which the QueryDelay is used.</td></tr> <tr><td>QueryMessageLimit</td> <td>The maximum number of messages to query from the database at a time</td></tr> <tr><td>QueryTimeout</td> <td>The database query timeout</td></tr></tbody></table> <p>The bus outbox includes some additional settings:</p> <table><thead><tr><th>Setting</th> <th>Description</th></tr></thead> <tbody><tr><td>MessageDeliveryLimit</td> <td>The number of messages to deliver at a time from the outbox to the broker</td></tr> <tr><td>MessageDeliveryTimeout</td> <td>Transport Send timeout when delivering messages to the transport</td></tr> <tr><td>DisableDeliveryService()</td> <td>Disable the outbox message delivery service, removing the hosted service from the service collection</td></tr></tbody></table></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/advanced/transactional-outbox.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/29/2023, 4:08:18 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/middleware/scoped.html" class="prev">
        Scoped Filters
      </a></span> <span class="next"><a href="/usage/message-data.html">
        Message Data
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f6b98727.js" defer></script><script src="/assets/js/3.5d941158.js" defer></script><script src="/assets/js/61.fdf4d890.js" defer></script>
  </body>
</html>
